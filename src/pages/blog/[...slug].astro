---
import { getCollection, render, type CollectionEntry } from "astro:content";
import Layout from "@layouts/Layout.astro";
import ReadingProgress from "@components/blog/reading-progress.astro";
import TableOfContents from "@components/blog/table-of-contents.astro";
import RelatedPosts from "@components/blog/related-posts.astro";
import ArticleHeader from "@components/blog/article-header.astro";
import ArticleContent from "@components/blog/article-content.astro";
import ShareSection from "@components/blog/share-section.astro";
import ArticleNavigation from "@components/blog/article-navigation.astro";
import { formatDate, calculateReadingTime } from "@/utils/blog";
import { useTranslations } from "@/i18n/utils";

// Generate static paths for Spanish blog posts only
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft && post.id.startsWith('es/'))
    .map((post) => ({
      params: { slug: post.id.replace('es/', '') },
      props: { post },
    }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content, headings } = await render(post);
const readingTime = calculateReadingTime(post.body || "");
const t = useTranslations('es');
---

<Layout
  title={`${post.data.title} - Blog`}
  description={post.data.description}
  type="article"
  image={post.data.image?.url}
  publishedTime={post.data.pubDate.toISOString()}
  modifiedTime={(post.data.updatedDate || post.data.pubDate).toISOString()}
>
  <!-- Reading Progress Bar -->
  <ReadingProgress />

  <!-- Structured Data for SEO - Article -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "image": post.data.image?.url || `https://oscargallegoruiz.com/og-image.jpg`,
    "datePublished": post.data.pubDate.toISOString(),
    "dateModified": (post.data.updatedDate || post.data.pubDate).toISOString(),
    "author": {
      "@type": "Person",
      "name": post.data.author,
      "url": "https://oscargallegoruiz.com",
      "sameAs": [
        "https://github.com/garbarok",
        "https://linkedin.com/in/oscargallegoruiz",
        "https://twitter.com/garbarok"
      ]
    },
    "publisher": {
      "@type": "Person",
      "name": "Óscar Gallego",
      "url": "https://oscargallegoruiz.com"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": Astro.url.href
    },
    "keywords": post.data.tags?.join(", ") || "",
    "wordCount": post.body?.split(/\s+/).length || 0,
    "timeRequired": `PT${readingTime}M`,
    "inLanguage": "es-ES"
  })} slot="head" />

  <!-- Breadcrumb Structured Data -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "https://oscargallegoruiz.com"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://oscargallegoruiz.com/blog"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": post.data.title,
        "item": Astro.url.href
      }
    ]
  })} slot="head" />

  <article class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Back button -->
    <div class="mb-8 mt-16">
      <a
        href="/blog"
        class="group inline-flex items-center gap-2 text-sm font-medium text-gray-600 transition-colors hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400"
      >
        <svg
          class="h-4 w-4 transition-transform group-hover:-translate-x-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Volver al blog
      </a>
    </div>

    <!-- Article Header -->
    <ArticleHeader post={post} readingTime={readingTime} />

    <!-- Featured Image -->
    {
      post.data.image && (
        <div class="mx-auto mt-12 max-w-4xl">
          <div class="aspect-[16/9] overflow-hidden rounded-2xl bg-gray-100 shadow-xl dark:bg-gray-800">
            <img
              src={post.data.image.url}
              alt={post.data.image.alt}
              class="h-full w-full object-cover"
              loading="eager"
            />
          </div>
        </div>
      )
    }

    <!-- Table of Contents -->
    <div class="mx-auto mt-12 max-w-4xl">
      <TableOfContents headings={headings} />
    </div>

    <!-- Article Content -->
    <div class="mx-auto mt-8 max-w-7xl">
      <div class="grid grid-cols-1">
        <!-- Main Content -->
        <ArticleContent Content={Content} />
      </div>
    </div>

    <!-- Bottom sections with consistent width -->
    <div class="mx-auto mt-12 max-w-7xl">
      <div class="grid grid-cols-1 gap-x-12 ">
        <div class="min-w-0">
          <!-- Updated Date -->
          {
            post.data.updatedDate && (
              <div class="border-t border-gray-200 pt-8 dark:border-gray-800">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Última actualización:{" "}
                  <time datetime={post.data.updatedDate.toISOString()}>
                    {formatDate(post.data.updatedDate, 'es')}
                  </time>
                </p>
              </div>
            )
          }

          <!-- Share Section -->
          <ShareSection
            title={post.data.title}
            url={Astro.url.href}
            shareText={t('blog.shareThisArticle')}
            shareOnTwitter={t('blog.shareOnTwitter')}
            shareOnLinkedIn={t('blog.shareOnLinkedIn')}
          />

          <!-- Related Posts -->
          <div class="mt-16 border-t border-gray-200 pt-12 dark:border-gray-800">
            <RelatedPosts
              currentPost={post}
              limit={3}
              relatedPostsTitle={t('blog.relatedPosts')}
              lang="es"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation to other posts -->
    <ArticleNavigation />
  </article>
</Layout>

<style>
  /* Additional custom styles for code blocks */
  article :global(pre) {
    padding: 1.5rem;
    overflow-x: auto;
  }
</style>
