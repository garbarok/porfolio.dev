---
import { getCollection, render, type CollectionEntry } from "astro:content";
import Layout from "@layouts/Layout.astro";
import TableOfContents from "@components/blog/table-of-contents.astro";
import RelatedPosts from "@components/blog/related-posts.astro";
import ArticleHeader from "@components/blog/article-header.astro";
import ArticleContent from "@components/blog/article-content.astro";
import ShareSection from "@components/blog/share-section.astro";
import ArticleNavigation from "@components/blog/article-navigation.astro";
import { formatDate, calculateReadingTime } from "@/utils/blog";
import { useTranslations } from "@/i18n/utils";

// Generate static paths for all English blog posts
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft && post.id.startsWith('en/'))
    .map((post) => ({
      params: { slug: post.id.replace('en/', '') },
      props: { post },
    }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content, headings } = await render(post);
const readingTime = calculateReadingTime(post.body || "");
const t = useTranslations('en');
---

<Layout
  title={`${post.data.title} - Blog`}
  description={post.data.description}
  type="article"
  image={post.data.image?.url}
  publishedTime={post.data.pubDate.toISOString()}
  modifiedTime={(post.data.updatedDate || post.data.pubDate).toISOString()}
  lang="en"
>
  <!-- Structured Data for SEO - Article -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "image": post.data.image?.url || `https://oscargallegoruiz.com/og-image.jpg`,
    "datePublished": post.data.pubDate.toISOString(),
    "dateModified": (post.data.updatedDate || post.data.pubDate).toISOString(),
    "author": {
      "@type": "Person",
      "name": post.data.author,
      "url": "https://oscargallegoruiz.com",
      "sameAs": [
        "https://github.com/garbarok",
        "https://linkedin.com/in/oscargallegoruiz",
        "https://twitter.com/garbarok"
      ]
    },
    "publisher": {
      "@type": "Person",
      "name": "Ã“scar Gallego",
      "url": "https://oscargallegoruiz.com"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": Astro.url.href
    },
    "keywords": post.data.tags?.join(", ") || "",
    "wordCount": post.body?.split(/\s+/).length || 0,
    "timeRequired": `PT${readingTime}M`,
    "inLanguage": "en-US"
  })} slot="head" />

  <!-- Breadcrumb Structured Data -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://oscargallegoruiz.com/en"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://oscargallegoruiz.com/en/blog"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": post.data.title,
        "item": Astro.url.href
      }
    ]
  })} slot="head" />

  <article class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Back button -->
    <div class="mb-8 mt-16">
      <a
        href="/en/blog"
        class="group inline-flex items-center gap-2 text-sm font-medium text-gray-600 transition-colors hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400"
      >
        <svg
          class="h-4 w-4 transition-transform group-hover:-translate-x-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to blog
      </a>
    </div>

    <!-- Article Header -->
    <ArticleHeader post={post} readingTime={readingTime} />

    <!-- Featured Image -->
    {
      post.data.image && (
        <div class="mt-8 max-w-4xl">
          <div class="aspect-[16/9] overflow-hidden rounded-2xl bg-gray-100 shadow-xl dark:bg-gray-800">
            <img
              src={post.data.image.url}
              alt={post.data.image.alt}
              class="h-full w-full object-cover"
              loading="eager"
            />
          </div>
        </div>
      )
    }

    <!-- Mobile Table of Contents (collapsible, visible only on mobile/tablet) -->
    {headings.filter((h) => h.depth <= 3).length > 0 && (
      <div class="mx-auto mt-12 max-w-4xl lg:hidden">
        <details class="group rounded-lg border border-gray-200 bg-gray-50/50 dark:border-gray-800 dark:bg-gray-900/50">
          <summary class="flex cursor-pointer items-center justify-between p-4 text-sm font-semibold text-gray-900 transition-colors hover:text-blue-600 dark:text-white dark:hover:text-blue-400">
            <span class="uppercase tracking-wider">{t('blog.inThisArticle')}</span>
            <svg
              class="h-5 w-5 transition-transform group-open:rotate-180"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="border-t border-gray-200 p-4 dark:border-gray-800">
            <TableOfContents headings={headings} />
          </div>
        </details>
      </div>
    )}

    <!-- Article Content with Sidebar Layout -->
    <div class="mx-auto mt-12 grid max-w-7xl grid-cols-1 gap-12 lg:grid-cols-[minmax(0,896px)_280px]">
      <!-- Main Content with max-w-4xl -->
      <div class="min-w-0">
        <ArticleContent Content={Content} />
      </div>

      <!-- Sidebar with Table of Contents (visible only on desktop, outside max-w-4xl) -->
      <aside class="hidden lg:block">
        <TableOfContents headings={headings} />
      </aside>
    </div>

    <!-- Bottom sections with consistent width -->
    <div class="mt-8 max-w-4xl">
      <div class="grid grid-cols-1 gap-x-12 ">
        <div class="min-w-0">
          <!-- Updated Date -->
          {
            post.data.updatedDate && (
              <div class="border-t border-gray-200 pt-8 dark:border-gray-800">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Last updated:{" "}
                  <time datetime={post.data.updatedDate.toISOString()}>
                    {formatDate(post.data.updatedDate, 'en')}
                  </time>
                </p>
              </div>
            )
          }

          <!-- Share Section -->
          <ShareSection
            title={post.data.title}
            url={Astro.url.href}
            shareText={t('blog.shareThisArticle')}
            shareOnTwitter={t('blog.shareOnTwitter')}
            shareOnLinkedIn={t('blog.shareOnLinkedIn')}
          />

          <!-- Related Posts -->
          <div class="mt-16 border-t border-gray-200 pt-12 dark:border-gray-800">
            <RelatedPosts
              currentPost={post}
              limit={3}
              relatedPostsTitle={t('blog.relatedPosts')}
              lang="en"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation to other posts -->
    <ArticleNavigation />
  </article>
</Layout>

<script is:inline define:vars={{ post, readingTime }}>
  (function() {
    // Initialize article tracking
    function initArticleTracking() {
      const articleContext = {
        title: post.data.title,
        slug: post.id.replace('es/', '').replace('en/', ''),
        tags: post.data.tags || [],
        language: post.id.startsWith('en/') ? 'en' : 'es',
        author: post.data.author,
        publishedDate: post.data.pubDate.toISOString(),
        readingTime: readingTime,
      }

      // Import analytics functions dynamically
      import('@/utils/blog-analytics').then(({
        setBlogArticleContext,
        trackArticleOpened,
        trackTimeSpent,
        trackBackToBlog
      }) => {
        // Set article context in Sentry
        setBlogArticleContext(articleContext)

        // Track article opened
        trackArticleOpened(articleContext)

        // Track time spent when user leaves
        const startTime = Date.now()

        const trackTimeOnPage = () => {
          const timeSpent = Math.floor((Date.now() - startTime) / 1000)
          trackTimeSpent(articleContext, timeSpent)
        }

        // Track on page unload
        window.addEventListener('beforeunload', trackTimeOnPage)

        // Track on navigation away (for SPAs)
        document.addEventListener('astro:before-preparation', trackTimeOnPage)

        // Track back to blog clicks
        const backButtons = document.querySelectorAll('a[href="/en/blog"]')
        backButtons.forEach((button) => {
          button.addEventListener('click', trackBackToBlog)
        })
      })
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initArticleTracking)

    // Reinitialize after view transitions
    document.addEventListener('astro:page-load', initArticleTracking)
  })()
</script>

<style>
  /* Additional custom styles for code blocks */
  article :global(pre) {
    padding: 1.5rem;
    overflow-x: auto;
  }
</style>
