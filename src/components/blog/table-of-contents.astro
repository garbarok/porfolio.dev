---
import { getLangFromUrl, useTranslations } from '@/i18n/utils'



export interface Heading {
  depth: number
  slug: string
  text: string
}

interface Props {
  headings: Heading[]
}

const { headings } = Astro.props

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

// Filter to only show H2 and H3 headings
const tocHeadings = headings.filter((h) => h.depth <= 3)
---

{
  tocHeadings.length > 0 && (
    <nav class="toc-nav rounded-lg border border-gray-200 bg-gray-50/50 p-4 dark:border-gray-800 dark:bg-gray-900/50" aria-label={t('blog.tableOfContents')}>
      <h2 class="text-xs font-semibold uppercase tracking-wider text-gray-700 dark:text-gray-300">
        {t('blog.inThisArticle')}
      </h2>
      <ul class="mt-3 space-y-2 border-l-2 border-gray-300 dark:border-gray-700">
        {tocHeadings.map((heading) => (
          <li
            class:list={[
              'toc-item',
              {
                'pl-3': heading.depth === 2,
                'pl-6': heading.depth === 3,
              },
            ]}
          >
            <a
              href={`#${heading.slug}`}
              class="toc-link block text-xs leading-relaxed text-gray-600 transition-colors hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400"
              data-toc-link={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  import { trackTOCClick } from '@/utils/blog-analytics'

  // Highlight active section in TOC
  function highlightActiveHeading() {
    const tocLinks = document.querySelectorAll('[data-toc-link]')
    if (tocLinks.length === 0) return

    const headings = Array.from(tocLinks)
      .map((link) => {
        const id = link.getAttribute('data-toc-link')
        return document.getElementById(id!)
      })
      .filter((heading): heading is HTMLElement => heading !== null)

    // Get article context from meta tags
    const getArticleContext = () => {
      const metaTitle = document.querySelector('meta[property="og:title"]')?.getAttribute('content')
      const metaUrl = document.querySelector('meta[property="og:url"]')?.getAttribute('content')

      if (!metaTitle || !metaUrl) return null

      const pathParts = window.location.pathname.split('/')
      const slug = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2]
      const language = pathParts.includes('en') ? 'en' : 'es'

      return {
        title: metaTitle.replace(' - Blog', ''),
        slug: slug,
        tags: [],
        language: language as 'es' | 'en',
        author: 'Ã“scar Gallego',
        publishedDate: new Date().toISOString(),
        readingTime: 5,
      }
    }

    // Track TOC clicks
    tocLinks.forEach((link) => {
      link.addEventListener('click', () => {
        const headingSlug = link.getAttribute('data-toc-link')
        const headingText = link.textContent?.trim()
        const depth = link.classList.contains('pl-4') ? 2 : 3

        const articleContext = getArticleContext()
        if (articleContext && headingSlug && headingText) {
          trackTOCClick(articleContext, {
            headingText,
            headingSlug,
            depth,
          })
        }
      })
    })

    function updateActiveLink() {
      let activeHeading: HTMLElement | null = null

      // Find the heading that's currently in view
      for (const heading of headings) {
        const rect = heading.getBoundingClientRect()
        if (rect.top <= 100) {
          activeHeading = heading
        } else {
          break
        }
      }

      // Update active states
      tocLinks.forEach((link) => {
        const id = link.getAttribute('data-toc-link')
        if (id === activeHeading?.id) {
          link.classList.add('active')
          link.classList.remove('text-gray-600', 'dark:text-gray-400')
          link.classList.add('text-blue-600', 'font-medium', 'dark:text-blue-400')
        } else {
          link.classList.remove('active', 'font-medium')
          link.classList.remove('text-blue-600', 'dark:text-blue-400')
          link.classList.add('text-gray-600', 'dark:text-gray-400')
        }
      })
    }

    // Run on scroll and initial load
    window.addEventListener('scroll', updateActiveLink, { passive: true })
    updateActiveLink()
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', highlightActiveHeading)

  // Reinitialize after view transitions
  document.addEventListener('astro:page-load', highlightActiveHeading)
</script>

<style>
  .toc-nav {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }

  .toc-nav::-webkit-scrollbar {
    width: 4px;
  }

  .toc-nav::-webkit-scrollbar-thumb {
    background-color: rgb(209 213 219);
    border-radius: 2px;
  }

  :global(.dark) .toc-nav::-webkit-scrollbar-thumb {
    background-color: rgb(55 65 81);
  }
</style>
