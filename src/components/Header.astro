---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import LanguageSwitcher from '@components/LanguageSwitcher.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  {
    title: t("nav.experience"),
    label: "experiencia",
    url: lang === 'es' ? "/#experiencia" : "/en/#experiencia",
  },
  {
    title: t("nav.projects"),
    label: "proyectos",
    url: lang === 'es' ? "/#proyectos" : "/en/#proyectos",
  },
  {
    title: t("nav.about"),
    label: "sobre-mi",
    url: lang === 'es' ? "/#sobre-mi" : "/en/#sobre-mi",
  },
  {
    title: t("nav.blog"),
    label: "blog",
    url: lang === 'es' ? "/blog" : "/en/blog",
  },
  {
    title: t("nav.contact"),
    label: "contacto",
    url: lang === 'es' ? "/contact" : "/en/contact",
  },
];

const currentPath = Astro.url.pathname;
---

<header
  class="fixed top-0 z-50 w-full"
>
  <nav class="relative bg-gray-800/50 after:pointer-events-none after:absolute after:inset-x-0 after:bottom-0 after:h-px after:bg-white/10">
    <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
      <div class="relative flex h-16 items-center justify-between">
        <!-- Mobile menu button -->
        <div class="absolute inset-y-0 left-0 flex items-center sm:hidden">
          <button
            id="mobile-menu-button"
            type="button"
            class="relative inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-white/5 hover:text-white focus:outline-2 focus:-outline-offset-1 focus:outline-indigo-500"
            aria-label="Toggle menu"
            aria-expanded="false"
          >
            <span class="absolute -inset-0.5"></span>
            <span class="sr-only">Open main menu</span>
            <svg id="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
              <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <svg id="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 hidden">
              <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>

        <!-- Centered nav items -->
        <div class="flex flex-1 items-center justify-center">
          <div class="hidden sm:block">
            <div class="flex items-center space-x-4">
              {
                navItems.map((link) => (
                  <a
                    href={link.url}
                    aria-label={link.label}
                    class:list={[
                      "rounded-md px-3 py-2 text-sm font-medium transition",
                      {
                        "bg-gray-950/50 text-white": currentPath === link.url || (currentPath.startsWith(link.url) && link.url !== "/"),
                        "text-gray-300 hover:bg-white/5 hover:text-white": !(currentPath === link.url || (currentPath.startsWith(link.url) && link.url !== "/"))
                      }
                    ]}
                  >
                    {link.title}
                  </a>
                ))
              }
              <div class="border-l border-gray-600 h-6 mx-2"></div>
              <LanguageSwitcher />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile menu -->
    <div id="mobile-menu" class="hidden sm:hidden">
      <div class="space-y-1 px-2 pt-2 pb-3">
        {
          navItems.map((link) => (
            <a
              href={link.url}
              aria-label={link.label}
              class:list={[
                "block rounded-md px-3 py-2 text-base font-medium transition",
                {
                  "bg-gray-950/50 text-white": currentPath === link.url || (currentPath.startsWith(link.url) && link.url !== "/"),
                  "text-gray-300 hover:bg-white/5 hover:text-white": !(currentPath === link.url || (currentPath.startsWith(link.url) && link.url !== "/"))
                }
              ]}
            >
              {link.title}
            </a>
          ))
        }
        <div class="border-t border-gray-600 my-2"></div>
        <div class="px-3 py-2">
          <LanguageSwitcher />
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  import { createMobileMenuManager } from "@/utils/mobileMenu";
  import {
    createSectionHighlighter,
    isHomePage,
  } from "@/utils/sectionHighlight";

  document.addEventListener("astro:page-load", () => {
    // Initialize mobile menu
    createMobileMenuManager();

    // Initialize section highlighting only on home pages
    if (isHomePage(window.location.pathname)) {
      const sections = document.querySelectorAll("section");
      const navItems = document.querySelectorAll("header nav a");

      if (sections.length > 0 && navItems.length > 0) {
        // Exclude sections that are separate pages (not homepage sections)
        createSectionHighlighter(
          {
            sections,
            navItems,
            headerOffset: 150,
            bottomOffset: 100,
          },
          undefined,
          ["blog", "contacto", "contact"]
        );
      }
    }
  });
</script>

<style>
  nav {
    animation: nav-shadow 1s linear both;
    animation-timeline: scroll();
    animation-range: 0 100px;
    backdrop-filter: blur(12px);
  }

  @keyframes nav-shadow {
    0% {
      background-color: rgb(31 41 55 / 0.5);
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.1);
    }
    to {
      background-color: rgb(31 41 55 / 0.8);
      box-shadow:
        0 10px 15px -3px rgb(0 0 0 / 0.5),
        0 4px 6px -4px rgb(0 0 0 / 0.5);
    }
  }
</style>
